<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>메인 페이지</title>
</head>
<body>
    <h2>메인 페이지</h2>

    <!-- 로그인 여부 확인 -->
    <div id="auth-button">
        <!-- 로그인 상태에 따라 버튼 표시 -->
        <a href="/signup"><button id="signup-btn">회원가입</button></a>
        <a href="/google/login"><button id="login-btn">Google로 로그인</button></a>
        <button id="logout-btn" onclick="logout()">로그아웃</button>
    </div>

    <!-- 게시판으로 이동 버튼 -->
    <div>
        <a href="/board"><button id="board-btn">게시판</button></a>
    </div>

    <script>
    // URL에서 인가 코드 추출
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const error = urlParams.get('error');

        console.log("code: ", code)

        if (code) {
            // 성공적으로 code를 추출한 경우, 서버로 전송
            fetch('http://127.0.0.1:8000/login/oauth2/google/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                // 응답이 200인 경우 처리
                if (data.message === 'login successful' || data.message === 'Signup success') {
                    window.location.href = `http://127.0.0.1:8000/main.html`;
                } else {
                    // 실패 시 오류 처리
                    throw new Error('Unexpected response message');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                // 실패 시에도 main.html로 이동
                window.location.href = `http://127.0.0.1:8000/main.html`;
            });
        } else {
            // code와 error가 모두 없는 경우, 기본 리디렉션
            console.error('No code or error found in URL');
            window.location.href = 'http://127.0.0.1:8000/main.html';
        }

    // 로그아웃 함수
    function logout() {
        localStorage.removeItem("access_token");
        document.cookie = "refresh_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        alert("로그아웃되었습니다.");
        location.reload();
    }

    // 로그인 상태 확인
    function checkLoginStatus() {
        const accessToken = localStorage.getItem("access_token");
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");

        if (accessToken) {
            loginBtn.style.display = "none";
            logoutBtn.style.display = "block";
        } else {
            loginBtn.style.display = "block";
            logoutBtn.style.display = "none";
        }
    }
</script>

</body>
</html>
